#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use App\Command\AddCommand;
use App\Command\DeleteCommand;
use App\Command\GetCommand;
use App\Command\InitCommand;
use App\Command\MenuCommand;
use App\Command\UpdateCommand;
use App\Platform\Paths;
use App\Platform\ProcessLock;
use App\Support\ErrorHandler;
use App\Support\LoggerFactory;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\Command\ListCommand;

umask(0077);

ErrorHandler::register();

Paths::ensureDataDir();

if (!ProcessLock::acquire()) {
    fwrite(STDERR, "Another instance is running. Close it first.\n");
    exit(1);
}

// Release on shutdown
register_shutdown_function(static function (): void {
    ProcessLock::release();
});

$application = new Application('php-cli-password-manager', '0.1.0');
$application->add(new MenuCommand());
$application->add(new InitCommand());
$application->add(new AddCommand());
$application->add(new ListCommand());
$application->add(new GetCommand());
$application->add(new UpdateCommand());
$application->add(new DeleteCommand());

$application->setDefaultCommand('menu', true);

LoggerFactory::get();

$application->run();
